# Git Workflow tasks (using gw CLI)
#
# Worktree-aware git workflow.
# Uses origin/main as base instead of local main branch.
#
# gw: cargo install git-workflow
# https://crates.io/crates/git-workflow

["git:home"]
description = "Switch to home branch and sync with origin/main"
run = "gw home"

["git:new"]
description = "Create new branch from origin/main (mise run git:new -- feature/name)"
run = "gw new"

["git:cleanup"]
description = "Delete merged branch and return to home (mise run git:cleanup -- [branch])"
run = "gw cleanup"

["git:status"]
description = "Show current git workflow state"
run = "gw status"

["git:pause"]
description = "Pause work: WIP commit + return to home (mise run git:pause -- [message])"
run = "gw pause"

["git:abandon"]
description = "Abandon changes and return to home"
run = "gw abandon"

["git:undo"]
description = "Undo last commit (soft reset HEAD~1)"
run = "gw undo"

["git:sync"]
description = "Sync current branch after base PR merge (update base to main, rebase, push)"
run = "gw sync"

["git:open-pr"]
description = "CI wait → open in browser → watch merge → cleanup (mise run git:open-pr -- <pr-number-or-url> [--no-wait])"
run = """
#!/bin/bash
set -euo pipefail

OPEN_URL_SCRIPT=".claude/skills/git-workflow/scripts/open-url.sh"

WAIT_CI=true
ARG=""
for arg in "$@"; do
  case "$arg" in
    --no-wait) WAIT_CI=false ;;
    *) ARG="$arg" ;;
  esac
done
if [[ -z "$ARG" ]]; then
  echo "Usage: mise run git:open-pr -- <pr-number-or-url> [--no-wait]" >&2
  exit 1
fi
if [[ "$ARG" =~ ^[0-9]+$ ]]; then
  PR_NUMBER="$ARG"
  URL=$(gh pr view "$PR_NUMBER" --json url --jq '.url')
else
  URL="$ARG"
  PR_NUMBER=$(echo "$URL" | grep -oE '[0-9]+$' || "")
fi

# Phase 1: Wait for CI
if [[ "$WAIT_CI" == true && -n "$PR_NUMBER" ]]; then
  echo "[git:open-pr] Phase 1/3: Waiting for CI checks on PR #${PR_NUMBER}..."
  gh pr checks "$PR_NUMBER" --watch || echo "[git:open-pr] CI checks failed or timed out, opening anyway"
fi

# Phase 2: Open in browser
echo "[git:open-pr] Phase 2/3: Opening PR in browser..."
if [[ -x "$OPEN_URL_SCRIPT" ]]; then
  "$OPEN_URL_SCRIPT" "$URL"
elif [[ "$(uname)" == "Darwin" ]]; then
  open "$URL"
elif command -v xdg-open &>/dev/null; then
  xdg-open "$URL"
else
  echo "Open: $URL"
fi

# Phase 3: Watch for merge
if [[ -n "$PR_NUMBER" ]]; then
  INTERVAL=30
  echo "[git:open-pr] Phase 3/3: Watching PR #${PR_NUMBER} for merge (interval: ${INTERVAL}s)..."
  while true; do
    STATE=$(gh pr view "$PR_NUMBER" --json state --jq '.state' 2>/dev/null || echo "ERROR")
    case "$STATE" in
      MERGED)
        echo ""
        echo "========================================"
        echo "[git:open-pr] PR #${PR_NUMBER} MERGED!"
        echo "========================================"
        if command -v osascript &>/dev/null; then
          osascript -e 'display notification "PR #'"${PR_NUMBER}"' merged. Running cleanup..." with title "Git Workflow" sound name "Glass"'
        fi
        echo "[git:open-pr] Running: mise run git:cleanup"
        mise run git:cleanup
        exit 0
        ;;
      CLOSED)
        echo "[git:open-pr] PR #${PR_NUMBER} was closed without merging"
        exit 0
        ;;
      OPEN)
        sleep "$INTERVAL"
        ;;
      ERROR)
        echo "[git:open-pr] Failed to fetch PR status, retrying..."
        sleep "$INTERVAL"
        ;;
    esac
  done
fi
"""

["git:worktree:status"]
description = "Show pool worktree status (available/total)"
run = "gw worktree pool status"

["git:worktree:acquire"]
description = "Acquire a pool worktree (prints path to stdout)"
run = "gw worktree pool acquire"

["git:worktree:release"]
description = "Release a pool worktree (mise run git:worktree:release -- <name>)"
run = "gw worktree pool release"

["git:watch-pr"]
description = "Watch PR and auto-cleanup when merged (mise run git:watch-pr -- <pr-number> [interval])"
run = ".claude/skills/git-workflow/scripts/git-watch-pr.sh"
